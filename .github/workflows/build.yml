name: Build AntiVurus Hack

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Build Python Installer
      run: |
        cd src/python_installer
        pip install -r requirements.txt
        pyinstaller --onefile --noconsole --icon=icon.ico --name="AntiVurusHack_Setup" installer.py
        mkdir ../../dist
        copy dist\AntiVurusHack_Setup.exe ..\..\dist\
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
    
    - name: Build C# Application
      run: |
        cd src/csharp_app
        dotnet restore
        dotnet publish -c Release -r win-x64 -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ../../dist --self-contained true
        copy Resources\* ..\..\dist\
    
    - name: Build C++ DLL
      run: |
        cd src/cpp_dll
        "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl /LD /Fe:virus.dll virus.cpp user32.lib kernel32.lib gdi32.lib winmm.lib advapi32.lib /link /DEF:exports.def
        copy virus.dll ..\..\dist\
    
    - name: Create Package
      run: |
        cd dist
        7z a -tzip AntiVurusHack_Full.zip *
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: AntiVurusHack
        path: |
          dist/
        retention-days: 7
